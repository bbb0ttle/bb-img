class BBImg extends HTMLElement{static get observedAttributes(){return["src","alt","placeholder","max-width","root-margin"]}constructor(){super(),this.observer=null,this.img=null,this.isLoaded=!1,this.loadId=0,this.attachShadow({mode:"open"})}get container(){return this.shadowRoot?.querySelector(".container")??null}connectedCallback(){this.render(),this.setupLazyLoading()}disconnectedCallback(){this.cleanup()}cleanup(){this.observer&&(this.observer.disconnect(),this.observer=null),this.img&&(this.img.onload=null,this.img.onerror=null)}attributeChangedCallback(t,n,e){if(n!==e)switch(t){case"src":this.isConnected&&this.resetAndLoad();break;case"alt":this.img&&(this.img.alt=e||"");break;case"placeholder":this.updatePlaceholderColor(e);break;case"max-width":this.updateMaxWidth(e)}}updatePlaceholderColor(t){const n=this.container;n&&!this.isLoaded&&(n.style.backgroundColor=t||"#f5f5f5")}updateMaxWidth(t){const n=t||"100%";this.style.maxWidth=n;const e=this.container;e&&(e.style.maxWidth=n)}resetAndLoad(){this.isLoaded=!1,this.loadId++,this.img&&(this.img.classList.remove("loaded"),this.img.onload=null,this.img.onerror=null,this.img.removeAttribute("src"));const t=this.container;t&&(t.classList.remove("loaded"),t.style.backgroundColor=this.getAttribute("placeholder")||"#f5f5f5"),this.observer&&this.observer.disconnect(),this.setupLazyLoading()}render(){const t=this.getAttribute("alt")||"",n=this.getAttribute("placeholder")||"#f5f5f5",e=this.getAttribute("max-width")||"100%";this.style.maxWidth=e,this.style.display="block",this.shadowRoot.innerHTML=`\n      <style>\n        :host {\n          display: block;\n          position: relative;\n          width: 100%;\n          max-width: ${e};\n          margin: 0 auto;\n        }\n        \n        .container {\n          position: relative;\n          width: 100%;\n          max-width: ${e};\n          aspect-ratio: 3/2;\n          background-color: ${n};\n          overflow: hidden;\n          margin: 0 auto;\n          /* 极淡的骨架屏：几乎不可察觉 */\n          transition: background-color 0.8s cubic-bezier(0.4, 0, 0.2, 1);\n        }\n        \n        /* 极简骨架屏：极淡的呼吸感 */\n        .container:not(.loaded)::before {\n          content: '';\n          position: absolute;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 0;\n          background: linear-gradient(\n            90deg,\n            transparent 0%,\n            rgba(128, 128, 128, 0.03) 50%,\n            transparent 100%\n          );\n          transform: translateX(-100%);\n          animation: breathe 3s ease-in-out infinite;\n        }\n        \n        @keyframes breathe {\n          0%, 100% { \n            transform: translateX(-100%);\n            opacity: 0;\n          }\n          50% { \n            transform: translateX(100%);\n            opacity: 1;\n          }\n        }\n        \n        .container.loaded {\n          background-color: transparent;\n        }\n        \n        .container.loaded::before {\n          animation: none;\n          opacity: 0;\n          transition: opacity 0.6s ease;\n        }\n        \n        img {\n          width: 100%;\n          height: 100%;\n          object-fit: cover;\n          opacity: 0;\n          /* 更长的过渡时间，更自然的缓动 */\n          transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1),\n                      transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);\n          transform: scale(1.02);\n          will-change: opacity, transform;\n          decoding: async;\n        }\n        \n        img.loaded {\n          opacity: 1;\n          transform: scale(1);\n        }\n        \n        /* 极简错误状态 */\n        .error {\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          width: 100%;\n          height: 100%;\n          color: #ccc;\n          font-size: 13px;\n          letter-spacing: 0.05em;\n        }\n        \n        .error-icon {\n          width: 32px;\n          height: 32px;\n          opacity: 0.3;\n        }\n      </style>\n      <div class="container">\n        <img alt="${t}" />\n      </div>\n    `,this.img=this.shadowRoot.querySelector("img")}setupLazyLoading(){if(!("IntersectionObserver"in window)||this.isInViewport())return void this.loadImage();const t=this.getAttribute("root-margin")||"50px";this.observer=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&!this.isLoaded&&(this.loadImage(),this.observer?.disconnect(),this.observer=null)})},{rootMargin:t,threshold:.01}),this.observer.observe(this)}isInViewport(){const t=this.getBoundingClientRect();return t.top<window.innerHeight&&t.bottom>0}loadImage(){const t=this.getAttribute("src");if(!t||!this.img)return;const n=++this.loadId;this.isLoaded=!0,this.img.onload=async()=>{if(n===this.loadId){try{"decode"in this.img&&await this.img.decode()}catch{}this.img.classList.add("loaded"),this.container?.classList.add("loaded")}},this.img.onerror=()=>{n===this.loadId&&(console.error(`Failed to load image: ${t}`),this.showError())},this.img.src=t}showError(){const t=this.container;t&&(t.innerHTML='\n      <div class="error">\n        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">\n          <path stroke-linecap="round" stroke-linejoin="round" \n            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />\n        </svg>\n      </div>\n    ',t.classList.add("loaded"))}reload(){this.resetAndLoad()}get loaded(){return this.isLoaded}}customElements.define("bb-img",BBImg);export{BBImg};